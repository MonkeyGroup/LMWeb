@using LM.Model.Model
@using LM.Utility
@{
    Layout = "~/Areas/Admin/Views/Shared/_Main.cshtml";
    ViewBag.Title = "数据备份与还原";

    var bakPath = ViewBag.BakPath;
}
@Html.RenderScript("/Areas/Admin/content/js/jquery.uploadify-v2.1.0/swfobject.js")
@Html.RenderScript("/Areas/Admin/content/js/jquery.uploadify-v2.1.0/jquery.uploadify.v2.1.0.min.js")

<script>
    $(document).ready(function () {
        // bak 文件上传
        $("#bakUploadify").uploadify({
            uploader: '/Areas/Admin/content/js/jquery.uploadify-v2.1.0/uploadify.swf',
            buttonText: 'Upload',
            cancelImg: '/Areas/Admin/content/js/jquery.uploadify-v2.1.0/cancel.png',
            script: '/Admin/Common/DbBackupUpload',
            queueID: 'fileQueue1',
            auto: true,
            multi: false,
            onComplete: function (even, queueId, fileObj, response, data) {
                var rs = JSON.parse(response);
                if (rs.Status) {
                    $('#bakPath').val(rs.FilePath);
                }
                alert(rs.Message);
            },
            uploadifyCancel: function () {
            }
        });
    });
</script>

<script type="text/javascript">
    var commitFlag = true;
    function restore() {
        // check null
        if ($('#bakPath').val() === null || $('#bakPath').val() === '') {
            alert('请先上传备份文件！');
            return;
        }
        if (!confirm('此操作将使数据库的数据还原到您上次备份的时刻，您确定要进行这样的不可逆操作吗？')) {
            return;
        }
        commitFlag = false;

        // 封装数据
        var ajax = {
            url: '/Admin/DbProcess/RestoreDb',
            type: 'Post',
            dataType: 'json',
            cache: false,
            contentType: "application/json; charset=utf-8",
            success: function (resp) {
                commitFlag = true;
                alert(resp.message);
            },
            error: function () {
                alert('系统故障，请联系管理员！');
                commitFlag = true;
            }
        }
        $.ajax(ajax);
    }


    var commitFlag2 = true;
    function backup() {
        if ($('#downloadPath').val() === '') {
            alert('请先备份数据库！');
            return;
        }
        commitFlag2 = false;

        // 封装数据
        var ajax = {
            url: '/Admin/DbProcess/BackupDb',
            type: 'Post',
            dataType: 'json',
            cache: false,
            contentType: "application/json; charset=utf-8",
            success: function (resp) {
                filePath = resp.data;
                commitFlag2 = true;
                alert(resp.message);
            },
            error: function () {
                alert('系统故障，请联系管理员！');
                commitFlag2 = true;
            }
        }
        $.ajax(ajax);
    }

    var filePath = '@bakPath';
    function download() {
        if (filePath === '') {
            alert('请先备份数据库！');
            return;
        }
        window.location.href = filePath;
    }
</script>

<!--3. Main-->
<div id="dcMain">
    <!-- 当前位置 -->
    <div id="urHere">
        后台管理中心<b>></b><strong>数据备份与还原</strong>
    </div>

    <div class="mainBox" style="height:auto!important;height:550px;min-height:550px;">
        <h3>数据备份与还原</h3>
        <table width="100%" border="0" cellpadding="8" cellspacing="0" class="tableBasic">
            <tr>
                <td>
                    <input name="submit" style="margin-left: 20%;" class="btn" type="button" value="数据库备份" onclick="return backup() && false;" />
                    <input style="margin-left: 0px; cursor: pointer; background-color: #40e0d0;" class="btn" type="button" value="下载备份文件"
                           id="dnbtn" onclick="download();"/>
                </td>
            </tr>
            <tr>
                <td>
                    <input name="submit" style="margin-left: 20%;" class="btn" type="button" value="数据库还原" onclick="return restore() && false;" />
                    <input id="bakPath" type="text" name="bakPath" class="inpMain" size="60" placeholder="请上传备份文件" />
                    <div id="fileQueue1" style="display: none;"></div>
                    <input id="bakUploadify" type="file" name="uploadify" />
                </td>
            </tr>
        </table>
    </div>

</div>







